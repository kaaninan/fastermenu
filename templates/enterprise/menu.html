{% extends 'enterprise/static/base.html' %}
{% load static %}
{% load bootstrap3 %}

{% block body %}

	<!-- Modal: Ürün Ekle -->
	<div class="modal fade" id="modal-add">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Ürün Ekleme</h4>
				</div>

				<form id="add-form" method="post" action="{% url 'api:menu_create' %}" enctype="multipart/form-data">
					<div class="modal-body">
						{% csrf_token %}
						{% bootstrap_form form %}
						<input type="text" name="enterprise" style="display: none" value="{{ request.user.profile.enterprise.id }}">
						<input type="text" name="category" style="display: none" value="{{ category.id }}">
						<hr>
						
						<!-- Options -->
						<div class="input_fields_wrap">
						</div>

						<div class="form-group">
							<button type="button" class="btn btn-primary add_field_button">Seçenek Ekle</button>
						</div>

					</div>
					
					<div class="modal-footer">
						<button type="submit" class="btn btn-success" id="add-button" style="width: 49%; float: left;">Ekle</button>
						<button type="button" class="btn btn-default" data-dismiss="modal" style="width: 49%; float: left">Vazgeç</button>
					</div>
				</form>
			</div>
		</div>
	</div>


	<!-- Modal: Ürün Duzenle -->
	<div class="modal fade" id="modal-edit">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Ürün Düzenle</h4>
				</div>

				<div class="modal-body">

					<div class="form-group">
						<label for="table-count">Menü Adı</label>
						<input type="text" class="form-control" name="edit-category-name">
					</div>

				</div>
			
				<div class="modal-footer">
					<button type="button" class="btn btn-success btn-success pull-left" id="button-save" style="width: 49%; float: left">Kaydet</button>
					<button type="button" class="btn btn-default pull-left" data-dismiss="modal" style="width: 49%; float: left;">Vazgeç</button>
				</div>
			</div>
		</div>
	</div>


	<!-- Modal: Ürün Sil -->
	<div class="modal fade" id="modal-delete">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">Ürün Sil</h4>
				</div>

				<div class="modal-body">
					<b><span id="delete-name"></span></b> isimli menü silinecektir. Onaylıyor musunuz?
				</div>
			
				<div class="modal-footer">
					<button type="button" class="btn btn-danger pull-left" id="button-delete" style="width: 49%; float: left">Sil</button>
					<button type="button" class="btn btn-default pull-left" data-dismiss="modal" style="width: 49%; float: left;">Vazgeç</button>
				</div>
			</div>
		</div>
	</div>



	<div class="content-wrapper">
		<div class="container">

			<section class="content-header">
				<h1>Menü Ayarları</h1>
				
				<ol class="breadcrumb">
					<li><a href="{% url 'enterprise:index' %}"><i class="fa fa-home"></i> Anasayfa</a></li>
					<li><a href="{% url 'enterprise:category' %}">Kategori</a></li>
					<li class="active">Menü</li>
				</ol>
			</section>

			<section class="content">

				{% if messages %}
					{% for message in messages %}
						<div class="alert alert-success alert-dismissible" role="alert">
							<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
							{{ message }}
						</div>
					{% endfor %}
				{% endif %}

				<div class="row">
					<div class="col-xs-12">

						<button type="button" class="btn btn-success" data-toggle="modal" data-target="#modal-add">
							<i class="fa fa-plus" aria-hidden="true"></i>&nbsp;&nbsp;Ürün Ekle
						</button>
						
						<br><br>

						<div class="box">

							<div class="box-header">
								<h3 class="box-title">{{ category }}</h3>

								<!-- Search -->
								<div class="box-tools">
									<div class="input-group input-group-sm" style="width: 150px;" style="position: relative">
										<form type="get" action="{% url 'enterprise:menu' id=category.id %}">
											<input type="text" name="search" class="form-control pull-right" style="border-radius:5px; height: 30px; z-index: 1; padding-right: 30px;" placeholder="Arama" value="{{ request.GET.search }}">
										</form>
									</div>
								</div>

							</div>

							<div class="box-body table-responsive no-padding">

								<table class="table table-hover">
									<tr style="font-size: 1.5rem;">
										<th>#</th>
										<th>Ürün Adı</th>
										<th>Fiyat</th>
										<th>Stok Durumu</th>
										<th>İşlemler</th>
									</tr>
									
									{% for menu in menus %}
									<tr>
										<td class="menu-id">{{ menu.id }}</td>
										<td class="menu-name">{{ menu.name }}</td>
										<td>{{ menu.price|floatformat:2 }} TL</td>
										<td>
											{% if menu.stock == True %}<i class="fa fa-check-circle" style="color: green"></i>{% endif %}
											{% if menu.stock == False %}<i class="fa fa-times-circle" style="color: red"></i>{% endif %}
										</td>
										<td>
											<button type="button" class="btn btn-default btn-edit">Göster</button>
											&nbsp;&nbsp;
											<button type="button" class="btn btn-warning btn-edit">Düzenle</button>
											&nbsp;&nbsp;
											<button type="button" class="btn btn-danger btn-delete">Sil</button>
										</td>
									</tr>
									{% endfor %}

								</table>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>
	</div>
{% endblock %}

{% block script %}


	<script type="text/javascript">


		// ================================= MODAL UI EVENTS ============================================

		// When Click the edit button, this variable set to selected item's id
		var selectedID = null;

		$(function(){


			// MODAL: ADD

			$('#add-form').submit(function(e) {
				var btn = $('#add-button');
				// btn.attr('disabled', 'disabled').html("Bekleyin...");
				e.preventDefault();

				var options = {
					beforeSubmit: function(arr, $form, options) { 
						console.log(arr);
						console.log($form);
						console.log(options);
					    // The array of form data takes the following form: 
					    // [ { name: 'username', value: 'jresig' }, { name: 'password', value: 'secret' } ] 
					     
					    // return false to cancel submit                  
					},
					success: function(){
						// window.location.href = "{% url 'enterprise:menu' id=category.id %}";
					}
				};
				$(this).ajaxSubmit(options);
			});

			

			// MODAL: UPDATE

			$('#button-save').click(function(e){

				// Get Edit Form Details

				var btn = $(event.target);
				btn.attr('disabled', 'disabled').html("Bekleyin...");

				id = selectedID;
				name = $('input[name="edit-category-name"]').val();
				enterprise = '{{ request.user.profile.enterprise.id }}'

				updateCategory(id, name, enterprise);


			});


			// MODAL: DELETE

			$('#button-delete').click(function(e){
				var btn = $(event.target);
				btn.attr('disabled', 'disabled').html("Bekleyin...");
				id = selectedID;
				enterprise = '{{ request.user.profile.enterprise.id }}'
				deleteItem(id, enterprise);
			});
		});




		// ================================ ADD-MODAL UI EVENTS ========================================

		// 1
		// Add Option Form (Click 'Secenek Ekle' button)
		$(function(){

			var wrapper         = $(".input_fields_wrap"); //Fields wrapper
			var add_button      = $(".add_field_button"); //Add button ID
			var count 			= 0;

			$(add_button).click(function(e){
				e.preventDefault();

				$(wrapper).append(`
				                  	<div>
					                  	<div class="form-group">
											<label class="control-label">Seçenek Başlığı</label>
											<input type="text" maxlength="30" class="form-control" name="optionName-`+count+`" required />
											<p class="help-block">Porsiyon, Malzemeler gibi başlıklar koyabilirsiniz.</p>
										</div>

										<div class="form-group">
											<label>Seçenek Türü</label>
											<select class="form-control" name="optionType-`+count+`" onchange="changeSelect(this);">
												<option value='' selected disabled hidden>Seçiniz</option>
												<option value='dropadd'>Ücretsiz Seçimler</option>
												<option value='option'>Ücretli Seçimler</option>
											</select>
										</div>

										<!-- Inputs: Displays when click 'Ucretsiz Secimler' -->
										<div class="form-group dropadd-div" style="display: none">
											<label>Seçim Listesi</label>
											<div class="controls">
												<div class="entry input-group col-xs-12" style="margin-bottom: 10px">
													<input class="form-control" name="optionFields-`+count+`[]" type="text" placeholder="Seçeneği Giriniz" />
													<span class="input-group-btn">
														<button class="btn btn-success btn-add" type="button">
															<span class="glyphicon glyphicon-plus"></span>
														</button>
													</span>
												</div>
											</div>
											<p class="help-block">Bu listeye 'soğan', 'acı biber' gibi tercihleri ekleyebilirsiniz.</p>
										</div>

										<!-- Inputs: Displays when click 'Ucretli Secimler' -->
										<div class="form-group option-div" style="display: none">
											<label>Seçim Listesi</label>
											<div class="input-area">
												<div class="input-fields">
													<div class="row entry-p">
														<div class="col-xs-6" style="padding-right: 0">
															<div class="form-group" style="margin-bottom: 10px">
																<input class="form-control" name="optionFields-`+count+`-p[]" type="text" placeholder="Seçeneği Giriniz" />
															</div>
														</div>
														<div class="col-sm-4 col-xs-3" style="padding: 0 0; margin-left: -1px">
															<div class="form-group" style="margin-bottom: 10px">
																<input class="form-control" name="optionFields-`+count+`-p[]" type="number" step="0.1" placeholder="Eklenecek Fiyatı Giriniz (₺)" />
															</div>
														</div>
														<div class="col-sm-2 col-xs-3 div-del-btn-p" style="padding-left: 10px; display:none">
															<div class="form-group">
																<button type="button" class="btn btn-danger btn-block btn-delete-p">Sil</button>
															</div>
														</div>
													</div>
												</div>
											</div>
											<div class="form-group">
												<button type="button" class="btn btn-default btn-add-p">Ekle</button>
											</div>
											<p class="help-block">Bu listeye porsiyon gibi tercihleri ekleyebilirsiniz. Örnek: </p>
											<p class="help-block">
												<ul>
													<li>1 Porsiyon - 0</li>
													<li>1.5 Porsiyon - 10 TL</li>
												</ul>
											</p>
											<p class="help-block" style="color: orange">Yazdığınız fiyat, ürün fiyatının üzerine eklenecektir.</p>
										</div>

										<div class="form-group">
											<button type="button" class="btn btn-danger remove_field">Seçeneği Sil</button>
										</div>

										<hr>
									</div>
				`);
				count++;
			});


			$(wrapper).on("click",".remove_field", function(e){ //user click on remove text
				e.preventDefault();
				$(this).parent('div').parent('div').remove();
				count--;
			})
		});



		// 1.1
		// in Extra Options
		// When Click 'Secenek Turu (Select-Option), show related inputs'
		function changeSelect(e){
			if(e.value == 'option'){
				$(e).parent().parent().find('.dropadd-div').hide();
				$(e).parent().parent().find('.option-div').show();

			}else if(e.value == 'dropadd'){
				$(e).parent().parent().find('.dropadd-div').show();
				$(e).parent().parent().find('.option-div').hide();
			}
		}

		// 1.2
		// in Ucretsiz Secenek - Inputs
		// When click the + button, add new input - When click the - button, delete input
		$(function(){
			$(document).on('click', '.btn-add', function(e){
				e.preventDefault();

				// console.log();

				var controlForm = $(this).parent().parent().parent(),
					currentEntry = $(this).parents('.entry:first'),
					newEntry = $(currentEntry.clone()).appendTo(controlForm);

				newEntry.find('input').val('');
				controlForm.find('.entry:not(:last) .btn-add')
					.removeClass('btn-add').addClass('btn-remove')
					.removeClass('btn-success').addClass('btn-danger')
					.html('<span class="glyphicon glyphicon-minus"></span>');
			
			}).on('click', '.btn-remove', function(e){
				$(this).parents('.entry:first').remove();
				e.preventDefault();
				return false;
			});
		});


		// 1.3
		// in Ucretli Secenek - Inputs
		// When click the + button, add new input - When click the - button, delete input
		$(function(){

			$(document).on('click', '.btn-add-p', function(e){
				e.preventDefault();

				var controlForm = $(this).parent().parent().children('.input-area'),
					currentEntry = $(this).parent().parent().children('.input-area').find('.input-fields:first'),
					newEntry = $(currentEntry.clone()).appendTo(controlForm);

				// Show Delete Button
				$(controlForm).find('.input-fields:last').find('.div-del-btn-p').show();

				newEntry.find('input').val('');
			
			}).on('click', '.btn-delete-p', function(e){
				$(this).parents('.input-fields:first').remove();
				e.preventDefault();
				return false;
			});
		});




		// ================================ GET INPUT VALUES ========================================


		function getOptionValues(){
			var inps = document.getElementsByName('optionType[]');
			for (var i = 0; i <inps.length; i++) {
				var inp=inps[i];
				console.log("optionType["+i+"].value="+inp.value);
			}
		};


		



		// ============================= jQuery REQUESTS ============================================


		// NOT NOW
		function updateCategory(id, name, enterprise){

			// CSRF Token for Django
			$.ajaxSetup({
				beforeSend: function(xhr, settings) {
				function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
				  var cookies = document.cookie.split(';');
				  for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					if (cookie.substring(0, name.length + 1) == (name + '=')) {
					  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					  break;
					}
				  }
				}
				return cookieValue;
				}if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
				}
				} 
			});

			var serialized = $.param({id: id, name: name, enterprise: enterprise});

			request = $.ajax({
				url: "{% url 'api:category_update' %}",
				type: "post",
				data: serialized
			});


			request.done(function (response, textStatus, jqXHR){
				console.log('Done');
				console.log(response);
				window.location.href = "{% url 'enterprise:category' %}";
				return false;
			});

			request.fail(function (jqXHR, textStatus, errorThrown){
				console.error("The following error occurred: " + textStatus, errorThrown);
			});
		}

		// WORKS
		function deleteItem(id, enterprise){

			// CSRF Token for Django
			$.ajaxSetup({
				beforeSend: function(xhr, settings) {
				function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
				  var cookies = document.cookie.split(';');
				  for (var i = 0; i < cookies.length; i++) {
					var cookie = jQuery.trim(cookies[i]);
					if (cookie.substring(0, name.length + 1) == (name + '=')) {
					  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					  break;
					}
				  }
				}
				return cookieValue;
				}if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
				}
				} 
			});

			var serialized = $.param({id: id, enterprise: enterprise});

			request = $.ajax({
				url: "{% url 'api:menu_delete' %}",
				type: "post",
				data: serialized
			});


			request.done(function (response, textStatus, jqXHR){
				console.log('Done');
				console.log(response);
				window.location.href = "{% url 'enterprise:menu' id=category.id %}";
				return false;
			});

			request.fail(function (jqXHR, textStatus, errorThrown){
				console.error("The following error occurred: " + textStatus, errorThrown);
			});
		}


		


		// ============================= TABLE UI EVENTS ============================================

		$(function(){


			// ============================= TABLE ITEM BUTTON ============================================


			// EDIT TABLE ITEM

			$(".btn-edit").click(function(e){
				itemID = $(this).parent().parent().find('.menu-id').html();
				itemName = $(this).parent().parent().find('.menu-name').html();

				selectedID = itemID;

				// Fill Edit Form with selected items
				$('input[name="edit-category-name"]').val(itemName);

				// Fill Delete Form with selected items (if click Delete button, it shows)
				$('span#delete-table-name').html(itemName);

				$('#modal-edit').modal('show');
			});



			// DELETE TABLE ITEM

			$(".btn-delete").click(function(e){
				itemID = $(this).parent().parent().find('.menu-id').html();
				itemName = $(this).parent().parent().find('.menu-name').html();

				console.log(itemID);

				selectedID = itemID;

				// Fill Edit Form with selected items
				$('#delete-name').html(itemName);

				$('#modal-delete').modal('show');
			});

		});

	</script>
{% endblock %}
