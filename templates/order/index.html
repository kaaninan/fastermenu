{% extends 'order/static/base.html' %}
{% load static %}

{% block body %}

<div class="container-index">

{% if addedState %}
<div class="alert alert-primary fade show alert-main" id="success-alert" style="text-align: center; padding: 15px 0;">
	<strong>Sepete Eklendi!</strong>
</div>
{% endif %}

<div class="row enterprise">
    <div class="col-4 clear">
        <img src="{{enterprise.logo.url}}">
    </div>


    <div class="col-8 clear">
        <div class="titleDiv">
            <div class="name">{{enterprise.name}}</div>
            <div class="location">Levent</div>
            <div class="table"><b>Masa:</b> {{table}}</div>
        </div>
    </div>
</div>



<div class="row search">
	<div class="col-12 clear">
		<input type="search" name="search" class="searchInput" placeholder="Ürün Arayın">
	</div>
</div>



{% for category in categories %}

<div class="row menu-title">
	<div class="col-12 clear">
		<div class="head">
			<div class="name">{{ category.name }}</div>
		</div>
	</div>
</div>

{% for menu in category.menu %}
<div class="row menu-item">
		<div class="col-2 col-sm-1 clear">
			<div class="add" id="{{ menu.id }}">
				<!-- For jQuery -->
				<div id="subCategory" style="display: none;">{{ menu.subcategory.count }}</div>
				<!-- End -->
				<i style="display: block" id="plus" class="fas fa-plus-circle"></i>
				<img id="loader" style="display: none" src="{% static 'img/spinner.gif' %}">
				<i id="check" style="display: none" class="fas fa-check"></i>
			</div>
		</div>

	
		<div class="col-7 col-sm-8 clear">
			<div class="record">
				<a href="{% url 'order:detail' id=menu.id %}">
					<div class="title">
						<div class="main">{{ menu.name }}</div>
						<div class="sub">Seçeceğiniz malzemeler ile</div>
					</div>
				</a>
			</div>
		</div>

		<div class="col-3 clear">
			<div class="price"><span id="price">{{ menu.price|floatformat:2 }}</span> TL</div>
		</div>

</div>

{% endfor %}

{% endfor %}




<div class="row no-gutter sepetim">
	<div class="col">
		<a href="{% url 'order:cart' %}">
			<span id="sepetim"></span>
			<i id="basket" class="fas fa-shopping-basket"></i>
		</a>
	</div>
</div>

</div>

{% csrf_token %}

{% endblock %}


{% block js %}
<script>


function getBudgetCount(){

	// CSRF Token for Django
	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
			}
		} 
	});

	request = $.ajax({
        url: "{% url 'cart:count' %}",
        type: "post"
    });

    // Callback handler that will be called on success
    request.done(function (response, textStatus, jqXHR){

        if(response['result'] != 0){
	        $("#basket").fadeOut('medium', function() {
			  $("span#sepetim").html(response['result']).fadeIn(function(){
			  	setTimeout(function(){
			  		$("span#sepetim").fadeOut('fast', function() {
						$("#basket").fadeIn('fast');
					});
			  	}, 1500);
			  });
			});
		}
    });

    // Callback handler that will be called on failure
    request.fail(function (jqXHR, textStatus, errorThrown){
        // Log the error to the console
        console.error(
            "The following error occurred: "+
            textStatus, errorThrown
        );
    });
}


function addBudget(id, price){

	// CSRF Token for Django
	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
			}
		} 
	});

	var serialized = $.param({id: id, price: price, option: -1, count: 1});

	request = $.ajax({
        url: "{% url 'cart:add' %}",
        type: "post",
        data: serialized
    });

    // Callback handler that will be called on success
    request.done(function (response, textStatus, jqXHR){
        // Log a message to the console
        console.log("Hooray, it worked!");
    });

    // Callback handler that will be called on failure
    request.fail(function (jqXHR, textStatus, errorThrown){
        // Log the error to the console
        console.error(
            "The following error occurred: "+
            textStatus, errorThrown
        );
    });
}



$(document).ready(function(){


	$("#success-alert").fadeTo(1500, 500).slideUp(500, function(){});


	getBudgetCount();


    $(".fa-plus-circle").click(function(){

    	var d = $.session.get('bucket');
    	console.log(d);

    	var element = $(this);

    	// Go Up One
        var parent = element.parent().get(0);

        // Get Menu Item Details
        var id = $(parent).attr('id');
		var subCategoryCount = parseInt(element.parent().find("#subCategory").html());
		var link = element.parent().parent().parent().find('a').attr('href');

		var price = parseFloat($('span#price').html());

		console.log(price);
        
		if (subCategoryCount > 0){
			// Go Details Page
			window.location.href = link;
			return false;

		}else{
			// Directly add cart
			addBudget(id, price);
		}

        element.css('display','none');
        element.parent().find('img').css('display','block');

   		newItem = 1;

		if($.session.get('bucket')){
			var old = $.session.get('bucket');
			newItem = parseInt(old) + 1;
		}
		$.session.set('bucket', newItem);

		// updateBucket();

        setTimeout(function(){
        	element.parent().find('img').css('display','none');
        	var check = element.parent().find('i')[1];
        	$(check).css('display','block');

        	getBudgetCount();

        	setTimeout(function(){
        		$(check).css('display','none');
        		element.parent().find("img").css('display','none');
        		element.css('display','block');

        	}, 1000);
        }, 1000);


    });
});



</script>

{% endblock %}

