{% extends 'order/static/base.html' %}
{% load static %}
{% load humanize %}
{% load parse_date %}

{% block body %}

<div class="container-index">

	<!-- Notifications -->

	{% if state.added %}
	<div class="alert alert-primary fade show alert-main" id="success-alert" style="text-align: center; padding: 15px 0;">
		<strong>Sepete Eklendi!</strong>
	</div>
	{% endif %}

	{% if state.deleteLine %}
	<div class="alert alert-primary fade show alert-main" id="success-alert" style="text-align: center; padding: 15px 0;">
		<strong>Siparişiniz Silindi!</strong>
	</div>
	{% endif %}

	<!-- END Notifications -->



	<!-- Enterprise -->

	<div class="row enterprise">

		{% if enterprise.logo %}
	    <div class="col-4 clear">
	        <img src="{{enterprise.logo.url}}">
	    </div>


	    <div class="col-8 clear">
	        <div class="titleDiv">
	            <div class="name">{{enterprise.name}}</div>
	            <div class="location">
	            	{% if enterprise.address %}
	            		{{enterprise.address|truncatechars:20 }}
	            	{% endif %}
	            </div>
	            <div class="table"><b>Masa:</b> {{table}}</div>
	        </div>
	    </div>
	    {% endif %}
	    

	    {% if not enterprise.logo %}

	    <div class="col-12">
	        <div class="titleDiv">
	            <div class="name">{{enterprise.name}}</div>
	            <div class="location">Levent</div>
	            <div class="table"><b>Masa:</b> {{table}}</div>
	        </div>
	    </div>

	    {% endif %}
	</div>

	<!-- END Enterprise -->


	<!-- 
	<div class="row search">
		<div class="col-12 clear">
			<input type="search" name="search" class="searchInput" placeholder="Ürün Arayın">
		</div>
	</div>
	 -->


	<!-- Last Orders -->


	{% if orders %}
		
		<div class="row menu-title">
			<div class="col-12 clear">
				<div class="head">
					<div class="name" style="color: #2F89F0">Önceki Siparişlerim</div>
				</div>
			</div>
		</div>

		{% for order in orders %}

			<div class="row menu-item">

			
				<div class="col-9">
					<div class="record">
						<a href="{% url 'order:track' id=order.id %}">
							<div class="title">
								<div class="main">
									{% for item in order.order %}
										{{ item }}{% if forloop.counter != order.order|length %},
										{% endif %}
									{% endfor %}
								</div>
								<!-- |parse_date:'%Y-%m-%d %H:%M:%S'| -->
								<div class="sub">
									<span style="color: #197E1C">
										{% if order.isPaid %}<b>Tamamlandı</b>
										{% elif not order.isComplated %}<b style="color: #F58B5B">Hazırlanıyor</b>
										{% elif order.isComplated %}<b>Siparişin Hazır</b>{% endif %}
									</span>
									- 
									{{ order.orderDate|naturaltime }} 
									- 
									Masa: {{ order.table }}
								</div>
							</div>
						</a>
					</div>
				</div>

				<div class="col-3 clear">
					<a href="{% url 'order:track' id=order.id %}">
						<div class="price" style="color: #197E1C">
							{% if not order.isCommented and order.isPaid %}<b>Yorum Yap</b>
							{% else %}Detay{% endif %}
						</div>
					</a>
				</div>

			</div>

		{% endfor %}

	{% endif %}

	 
		


	<!-- END Last Orders -->




	<!-- Menu -->


	{% for category in categories %}

		{% if category.menu.count != 0 %}

			<div class="row menu-title">
				<div class="col-12 clear">
					<div class="head">
						<div class="name">{{ category.name }}</div>
					</div>
				</div>
			</div>

			{% for menu in category.menu %}
			<div class="row menu-item">
					<div class="col-2 col-sm-1 clear">
						<div class="add" id="{{ menu.id }}">
							<!-- For jQuery -->
							<div id="subCategory" style="display: none;">{{ menu.subcategory.count }}</div>
							<!-- End -->
							<i style="display: block" id="plus" class="fas fa-plus-circle"></i>
							<div style="display: none" id="loader" class="loader"></div>
							<i id="check" style="display: none" class="fas fa-check"></i>
						</div>
					</div>

				
					<div class="col-7 col-sm-8 clear">
						<div class="record">
							<a href="{% url 'order:detail' id=menu.id %}">
								<div class="title">
									<div class="main">{{ menu.name }}</div>
									<div class="sub">{{ menu.description }}</div>
								</div>
							</a>
						</div>
					</div>

					<div class="col-3 clear">
						<a href="{% url 'order:detail' id=menu.id %}">
							<div class="price"><span id="price">{{ menu.price|floatformat:2 }}</span> TL</div>
						</a>
					</div>

			</div>

			{% endfor %}

		{% endif %}

	{% endfor %}


	<!-- END Menu -->



	<!-- Shopping Cart -->

	<div class="row no-gutter sepetim">
		<a href="{% url 'order:cart' %}">
			<div class="col sepetim-content">
				<span id="sepetim"></span>
				<i id="basket" class="fas fa-shopping-basket"></i>
			</div>
		</a>
	</div>

	<!-- END Shopping Cart -->

</div>

{% csrf_token %}

{% endblock %}


{% block js %}
<script>


function getBudgetCount(){

	// CSRF Token for Django
	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
			}
		} 
	});

	request = $.ajax({
        url: "{% url 'api:cart_count' %}",
        type: "post"
    });

    // Callback handler that will be called on success
    request.done(function (response, textStatus, jqXHR){

        if(response['result'] != 0){
	        $("#basket").fadeOut('medium', function() {
			  $("span#sepetim").html(response['result']).fadeIn(function(){
			  	setTimeout(function(){
			  		$("span#sepetim").fadeOut('fast', function() {
						$("#basket").fadeIn('fast');
					});
			  	}, 1500);
			  });
			});
		}
    });

    request.fail(function (jqXHR, textStatus, errorThrown){
        console.error(
            "The following error occurred: "+
            textStatus, errorThrown
        );
    });
}


function addBudget(id, price){

	// CSRF Token for Django
	$.ajaxSetup({
		beforeSend: function(xhr, settings) {
			function getCookie(name) {
				var cookieValue = null;
				if (document.cookie && document.cookie != '') {
					var cookies = document.cookie.split(';');
					for (var i = 0; i < cookies.length; i++) {
						var cookie = jQuery.trim(cookies[i]);
						if (cookie.substring(0, name.length + 1) == (name + '=')) {
							cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
							break;
						}
					}
				}
				return cookieValue;
			}if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
				xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
			}
		} 
	});

	var serialized = $.param({id: id, price: price, option: -1, count: 1});

	request = $.ajax({
        url: "{% url 'api:cart_add' %}",
        type: "post",
        data: serialized
    });

    request.done(function (response, textStatus, jqXHR){
    });

    request.fail(function (jqXHR, textStatus, errorThrown){
        console.error(
            "The following error occurred: "+
            textStatus, errorThrown
        );
    });
}



$(document).ready(function(){


	$("#success-alert").fadeTo(1500, 500).slideUp(500, function(){});


	getBudgetCount();


    $(".fa-plus-circle").click(function(e){

    	var element = $(e.currentTarget);

    	// Go Up One
        var parent = element.parent().get(0);

        // Get Menu Item Details
        var id = $(parent).attr('id');
		var subCategoryCount = parseInt(element.parent().find("#subCategory").html());
		var link = element.parent().parent().parent().find('a').attr('href');

		var price = parseFloat($(element.parents()[2]).find('span#price').html().replace(',','.'));

        
		if (subCategoryCount > 0){
			// Go Details Page
			window.location.href = link;
			return false;

		}else{
			// Directly add cart
			addBudget(id, price);
		}

        element.css('display','none');
        element.parent().find('#loader').css('display','block');


        setTimeout(function(){
        	element.parent().find('#loader').css('display','none');
        	var check = element.parent().find('i')[1];
        	$(check).css('display','block');

        	getBudgetCount();

        	setTimeout(function(){
        		$(check).css('display','none');
        		element.parent().find("#loader").css('display','none');
        		element.css('display','block');

        	}, 1000);
        }, 500);


    });
});



</script>

{% endblock %}

